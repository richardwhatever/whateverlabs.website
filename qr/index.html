<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Code Generator | Whatever Labs</title>
    <meta name="description" content="Generate QR codes instantly. A free tool by Whatever Labs.">

    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <link href="../style.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <link rel="apple-touch-icon" sizes="60x60" href="../apple-touch-icon.png">
    <link rel="icon" type="image/png" href="../favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="../favicon-16x16.png" sizes="16x16">
    <meta name="theme-color" content="#1a1a1a">

    <style>
        /* QR page overrides */
        body {
            background-image: url('../img/background_large.jpg');
        }

        h1 {
            margin-bottom: 12px;
        }

        /* Input section */
        .input-section {
            animation: fadeUp 0.8s var(--transition-smooth) 0.3s both;
        }

        .input-wrapper {
            position: relative;
            margin-bottom: 24px;
            display: flex;
            gap: 0;
        }

        .protocol-select {
            padding: 18px 12px;
            font-family: 'Lato', sans-serif;
            font-size: 1rem;
            font-weight: 400;
            color: var(--white);
            background: var(--white-ghost);
            border: 1px solid var(--white-faint);
            border-right: none;
            border-radius: 4px 0 0 4px;
            outline: none;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            cursor: pointer;
        }

        .protocol-select:focus {
            background: var(--white-faint);
            border-color: var(--white-subtle);
        }

        .protocol-select option {
            background: var(--dark);
            color: var(--white);
        }

        .input-wrapper input[type="url"] {
            border-radius: 0 4px 4px 0;
            flex: 1;
        }

        /* QR Code display */
        .qr-section {
            margin-top: 60px;
            animation: fadeUp 0.8s var(--transition-smooth) 0.4s both;
        }

        .qr-container {
            display: none;
            flex-direction: column;
            align-items: flex-start;
            gap: 30px;
        }

        .qr-container.visible {
            display: flex;
            animation: qrReveal 0.6s var(--transition-smooth) both;
        }

        @keyframes qrReveal {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .qr-frame {
            padding: 24px;
            background: var(--white);
            border-radius: 4px;
            box-shadow:
                0 25px 50px -12px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        #qrcode {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #qrcode canvas {
            display: block !important;
        }

        #qrcode img {
            display: none !important;
        }

        .qr-url {
            font-size: 0.8rem;
            color: var(--white-muted);
            word-break: break-all;
            max-width: 300px;
            line-height: 1.5;
        }

        .qr-url span {
            color: var(--white-subtle);
            display: block;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 6px;
        }

        .format-selector {
            margin-bottom: 20px;
        }

        .format-selector label {
            display: block;
            color: var(--white-subtle);
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 8px;
        }

        .format-select {
            width: 100%;
            padding: 12px 16px;
            font-family: 'Lato', sans-serif;
            font-size: 0.9rem;
            font-weight: 400;
            color: var(--white);
            background: var(--white-ghost);
            border: 1px solid var(--white-faint);
            border-radius: 4px;
            outline: none;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            cursor: pointer;
        }

        .format-select:focus {
            background: var(--white-faint);
            border-color: var(--white-subtle);
            box-shadow: 0 0 0 1px var(--white-faint);
        }

        .format-select option {
            background: var(--dark);
            color: var(--white);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .text-btn {
            background: none;
            border: none;
            color: var(--white-muted);
            font-family: 'Lato', sans-serif;
            font-size: 0.85rem;
            cursor: pointer;
            padding: 0;
            margin-bottom: 20px;
            transition: color 0.3s ease;
        }

        .text-btn:hover {
            color: var(--white);
        }

        /* Responsive */
        @media (max-width: 480px) {
            .qr-frame {
                padding: 20px;
            }

            .qr-url {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="page">
        <header>
            <a href="../">
                <img class="logo" src="../img/logo.png" alt="Whatever Labs">
            </a>
        </header>

        <main>
            <h1 class="anim-delay-1">QR Code Generator</h1>
            <p class="tagline anim-delay-2">Start typing to transform any URL into a scannable QR code</p>

            <div class="input-section">
                <div class="input-wrapper">
                    <select id="protocolSelect" class="protocol-select">
                        <option value="https://">https://</option>
                        <option value="http://">http://</option>
                    </select>
                    <input
                        type="text"
                        id="urlInput"
                        placeholder="example.com"
                        autocomplete="url"
                        spellcheck="false"
                    >
                </div>
            </div>

            <div class="qr-section">
                <div class="qr-container" id="qrContainer">
                    <div class="qr-frame">
                        <div id="qrcode"></div>
                    </div>

                    <div class="qr-actions">
                        <button class="text-btn" id="testLinkBtn">
                            Test Link â†—
                        </button>
                        <div class="format-selector">
                            <label for="filenameInput">Filename</label>
                            <input type="text" id="filenameInput" class="format-select" placeholder="qr-code">
                        </div>
                        <div class="format-selector">
                            <label for="formatSelect">Download Format</label>
                            <select id="formatSelect" class="format-select">
                                <option value="png">PNG (Raster)</option>
                                <option value="svg">SVG (Vector)</option>
                                <option value="pdf">PDF (Vector)</option>
                            </select>
                        </div>
                        <button class="btn" id="downloadBtn" style="margin-top: 20px;">
                            <svg class="btn-icon" viewBox="0 0 24 24">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            <span id="downloadBtnText">Download PNG</span>
                        </button>
                        <button class="btn" id="downloadAllBtn" style="margin-top: 12px;">
                            <svg class="btn-icon" viewBox="0 0 24 24">
                                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                                <polyline points="7 10 12 15 17 10"/>
                                <line x1="12" y1="15" x2="12" y2="3"/>
                            </svg>
                            Download All Formats (ZIP)
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <footer class="anim-delay-5">
            <div class="footer-content">
                <a href="../" class="footer-link">Whatever Labs</a>
                <span class="separator"></span>
                <a href="mailto:hello@whateverlabs.com" class="footer-link">hello@whateverlabs.com</a>
            </div>
        </footer>
    </div>

    <script>
        const protocolSelect = document.getElementById('protocolSelect');
        const urlInput = document.getElementById('urlInput');
        const testLinkBtn = document.getElementById('testLinkBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const downloadAllBtn = document.getElementById('downloadAllBtn');
        const formatSelect = document.getElementById('formatSelect');
        const filenameInput = document.getElementById('filenameInput');
        const downloadBtnText = document.getElementById('downloadBtnText');
        const qrcodeDiv = document.getElementById('qrcode');
        const qrContainer = document.getElementById('qrContainer');
        let qrInstance = null;
        let currentUrl = '';
        let filenameManuallyEdited = false;
        let debounceTimer = null;

        function getFullUrl() {
            const input = urlInput.value.trim();
            if (!input) return '';
            return protocolSelect.value + input;
        }

        function isValidUrl(string) {
            try {
                const url = new URL(string);
                return url.protocol === 'http:' || url.protocol === 'https:';
            } catch {
                return false;
            }
        }

        function generateQRCode() {
            const url = getFullUrl();

            if (!url || !isValidUrl(url)) {
                // Hide QR container if URL is invalid
                qrContainer.classList.remove('visible');
                currentUrl = '';
                return;
            }

            // Clear previous QR code
            qrcodeDiv.innerHTML = '';

            // Generate new QR code
            qrInstance = new QRCode(qrcodeDiv, {
                text: url,
                width: 200,
                height: 200,
                colorDark: '#1a1a1a',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });

            // Store current URL for download
            currentUrl = url;

            // Show container
            qrContainer.classList.add('visible');
        }

        function testLink() {
            if (currentUrl) {
                window.open(currentUrl, '_blank');
            }
        }

        function debouncedGenerate() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(generateQRCode, 300);
        }

        function generateFilenameFromUrl(url) {
            return url
                .replace(/^https?:\/\//, '')
                .replace(/\/+$/, '')
                .replace(/[^a-z0-9]/gi, '-')
                .replace(/-+/g, '-')
                .replace(/^-|-$/g, '')
                .substring(0, 30)
                .replace(/-$/, '');
        }

        function getFilename() {
            return filenameInput.value.trim() || 'qr-code';
        }

        function updateFilenameFromUrl() {
            if (!filenameManuallyEdited) {
                const url = getFullUrl();
                filenameInput.value = url ? generateFilenameFromUrl(url) : '';
            }
        }

        function downloadQRCode() {
            const format = formatSelect.value;
            const filename = getFilename();

            if (format === 'png') {
                downloadPNG(filename);
            } else if (format === 'svg') {
                downloadSVG(filename);
            } else if (format === 'pdf') {
                downloadPDF(filename);
            }
        }

        function downloadPNG(filename) {
            const canvas = qrcodeDiv.querySelector('canvas');
            if (canvas) {
                const link = document.createElement('a');
                link.download = `qr-${filename}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
            }
        }

        function downloadSVG(filename) {
            const url = currentUrl || getFullUrl();

            try {
                if (typeof qrcode !== 'undefined') {
                    const qr = qrcode(0, 'H');
                    qr.addData(url);
                    qr.make();

                    const moduleCount = qr.getModuleCount();
                    const cellSize = Math.max(1, Math.floor(200 / moduleCount));
                    const svgString = qr.createSvgTag(cellSize, 4).replace(/#000000/g, '#1a1a1a');

                    const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
                    const blobUrl = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = `qr-${filename}.svg`;
                    link.href = blobUrl;
                    link.click();
                    URL.revokeObjectURL(blobUrl);
                    return;
                }
            } catch (error) {
                console.error('Error generating SVG with qrcode-generator:', error);
            }

            // Fallback: Generate SVG from canvas (embedded PNG)
            // This creates a vector file that contains the raster image
            const canvas = qrcodeDiv.querySelector('canvas');
            if (canvas) {
                const imgData = canvas.toDataURL('image/png');
                const svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200" viewBox="0 0 200 200">
    <image x="0" y="0" width="200" height="200" xlink:href="${imgData}"/>
</svg>`;
                const blob = new Blob([svg], { type: 'image/svg+xml;charset=utf-8' });
                const blobUrl = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.download = `qr-${filename}.svg`;
                link.href = blobUrl;
                link.click();
                URL.revokeObjectURL(blobUrl);
            } else {
                alert('Error: QR code not found. Please generate a QR code first.');
            }
        }

        function downloadPDF(filename) {
            const canvas = qrcodeDiv.querySelector('canvas');
            if (!canvas) return;

            try {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'mm',
                    format: [80, 80]
                });

                // Get image data from canvas
                const imgData = canvas.toDataURL('image/png');
                
                // Calculate dimensions to fit in PDF (with padding)
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const padding = 5;
                const imgWidth = pdfWidth - (padding * 2);
                const imgHeight = imgWidth; // Square

                // Add image to PDF
                pdf.addImage(imgData, 'PNG', padding, padding, imgWidth, imgHeight);
                
                // Save PDF
                pdf.save(`qr-${filename}.pdf`);
            } catch (error) {
                console.error('Error generating PDF:', error);
                alert('Error generating PDF. Please try again.');
            }
        }

        // Helper functions to get file data for zip
        function getPNGData() {
            const canvas = qrcodeDiv.querySelector('canvas');
            if (!canvas) return null;
            
            return new Promise((resolve) => {
                canvas.toBlob((blob) => {
                    resolve(blob);
                }, 'image/png');
            });
        }

        function getSVGData() {
            const url = currentUrl || getFullUrl();

            return new Promise((resolve) => {
                try {
                    if (typeof qrcode !== 'undefined') {
                        const qr = qrcode(0, 'H');
                        qr.addData(url);
                        qr.make();

                        const moduleCount = qr.getModuleCount();
                        const cellSize = Math.max(1, Math.floor(200 / moduleCount));
                        const svgString = qr.createSvgTag(cellSize, 4).replace(/#000000/g, '#1a1a1a');

                        const blob = new Blob([svgString], { type: 'image/svg+xml;charset=utf-8' });
                        resolve(blob);
                        return;
                    }
                } catch (error) {
                    console.error('Error generating SVG with qrcode-generator:', error);
                }

                // Fallback: Generate SVG from canvas (embedded PNG)
                const canvas = qrcodeDiv.querySelector('canvas');
                if (canvas) {
                    const imgData = canvas.toDataURL('image/png');
                    const svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="200" height="200" viewBox="0 0 200 200">
    <image x="0" y="0" width="200" height="200" xlink:href="${imgData}"/>
</svg>`;
                    const blob = new Blob([svg], { type: 'image/svg+xml;charset=utf-8' });
                    resolve(blob);
                } else {
                    resolve(null);
                }
            });
        }

        function getPDFData() {
            const canvas = qrcodeDiv.querySelector('canvas');
            if (!canvas) return Promise.resolve(null);

            return new Promise((resolve, reject) => {
                try {
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: [80, 80]
                    });

                    // Get image data from canvas
                    const imgData = canvas.toDataURL('image/png');
                    
                    // Calculate dimensions to fit in PDF (with padding)
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const padding = 5;
                    const imgWidth = pdfWidth - (padding * 2);
                    const imgHeight = imgWidth; // Square

                    // Add image to PDF
                    pdf.addImage(imgData, 'PNG', padding, padding, imgWidth, imgHeight);
                    
                    // Get PDF as blob
                    const pdfBlob = pdf.output('blob');
                    resolve(pdfBlob);
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    reject(error);
                }
            });
        }

        async function downloadAllFormats() {
            if (!currentUrl && !getFullUrl()) {
                alert('Please generate a QR code first.');
                return;
            }

            const filename = getFilename();
            
            // Disable button during generation
            downloadAllBtn.disabled = true;
            const originalText = downloadAllBtn.innerHTML;
            downloadAllBtn.innerHTML = '<span>Generating ZIP...</span>';

            try {
                // Check if JSZip is available
                if (typeof JSZip === 'undefined') {
                    alert('Error: JSZip library not loaded. Please refresh the page.');
                    return;
                }

                const zip = new JSZip();

                // Get all format data
                const [pngData, svgData, pdfData] = await Promise.all([
                    getPNGData(),
                    getSVGData(),
                    getPDFData()
                ]);

                // Add files to zip
                if (pngData) {
                    zip.file(`qr-${filename}.png`, pngData);
                }
                if (svgData) {
                    zip.file(`qr-${filename}.svg`, svgData);
                }
                if (pdfData) {
                    zip.file(`qr-${filename}.pdf`, pdfData);
                }

                // Generate zip file
                const zipBlob = await zip.generateAsync({ type: 'blob' });
                
                // Download zip
                const link = document.createElement('a');
                link.download = `qr-${filename}-all-formats.zip`;
                link.href = URL.createObjectURL(zipBlob);
                link.click();
                URL.revokeObjectURL(link.href);
            } catch (error) {
                console.error('Error creating zip file:', error);
                alert('Error creating zip file. Please try again.');
            } finally {
                // Re-enable button
                downloadAllBtn.disabled = false;
                downloadAllBtn.innerHTML = originalText;
            }
        }

        // Update download button text when format changes
        formatSelect.addEventListener('change', () => {
            const format = formatSelect.value.toUpperCase();
            downloadBtnText.textContent = `Download ${format}`;
        });

        testLinkBtn.addEventListener('click', testLink);
        downloadBtn.addEventListener('click', downloadQRCode);
        downloadAllBtn.addEventListener('click', downloadAllFormats);

        // Generate QR code dynamically as user types
        urlInput.addEventListener('input', () => {
            updateFilenameFromUrl();
            debouncedGenerate();
        });

        // Regenerate when protocol changes
        protocolSelect.addEventListener('change', () => {
            updateFilenameFromUrl();
            debouncedGenerate();
        });

        // Track manual filename edits
        filenameInput.addEventListener('input', () => {
            filenameManuallyEdited = true;
        });
    </script>
</body>
</html>
